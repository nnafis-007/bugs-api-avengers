# Define upstream servers for load balancing
upstream backend_servers {
	least_conn;  # Use least connections algorithm
	server backend:4000 max_fails=3 fail_timeout=30s;
	# Add more backend instances here if you scale:
	# server backend2:4000 max_fails=3 fail_timeout=30s;
	# server backend3:4000 max_fails=3 fail_timeout=30s;
}

upstream campaign_servers {
	least_conn;
	server campaign-service:5000 max_fails=3 fail_timeout=30s;
}

upstream donation_servers {
	least_conn;
	server donation-service:6000 max_fails=3 fail_timeout=30s;
}

# Rate limiting zones
# 10m = 10 megabytes of memory, can store ~160,000 IP addresses
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;        # 10 requests/second for general API
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;        # 5 requests/second for auth endpoints
limit_req_zone $binary_remote_addr zone=donation_limit:10m rate=3r/s;    # 3 requests/second for donations
limit_req_zone $binary_remote_addr zone=campaign_limit:10m rate=20r/s;   # 20 requests/second for campaigns

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;

server {
	listen 80;
	server_name _;
	
	# Limit connections per IP
	limit_conn addr 10;  # Max 10 concurrent connections per IP

	# Normalize /api without trailing slash to /api/
	location = /api {
		return 301 /api/;
	}

	# Donation endpoints with rate limiting and load balancing
	location /api/donate {
		# Rate limiting: 3 requests/second, burst up to 5, delay excess requests
		limit_req zone=donation_limit burst=5 nodelay;
		
		# Load balanced upstream
		proxy_pass http://donation_servers;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		# Timeouts
		proxy_connect_timeout 5s;
		proxy_send_timeout 10s;
		proxy_read_timeout 30s;
	}
	
	# Campaign endpoints with rate limiting and load balancing
	location /api/campaigns {
		# Rate limiting: 20 requests/second, burst up to 30
		limit_req zone=campaign_limit burst=30 nodelay;
		
		# Load balanced upstream
		proxy_pass http://campaign_servers;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		# Timeouts
		proxy_connect_timeout 5s;
		proxy_send_timeout 10s;
		proxy_read_timeout 10s;
	}
	
	# Authentication endpoints with strict rate limiting
	location ~ ^/api/(register|login|logout|refresh) {
		# Strict rate limiting: 5 requests/second, burst up to 10
		limit_req zone=auth_limit burst=10 nodelay;
		
		# Load balanced upstream
		proxy_pass http://backend_servers;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		# Timeouts
		proxy_connect_timeout 5s;
		proxy_send_timeout 10s;
		proxy_read_timeout 15s;
	}
	
	# Other API endpoints with general rate limiting
	location /api/ {
		# General API rate limiting: 10 requests/second, burst up to 20
		limit_req zone=api_limit burst=20 nodelay;
		
		# Load balanced upstream
		proxy_pass http://backend_servers;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		# Timeouts
		proxy_connect_timeout 5s;
		proxy_send_timeout 10s;
		proxy_read_timeout 15s;
	}

	# Proxy Grafana (with subpath support) - BEFORE root location
	location /grafana/ {
		proxy_pass http://grafana:3000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		# WebSocket support for live updates
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
	}

# Redirect /prometheus to /prometheus/  (important)
location = /prometheus {
    return 301 /prometheus/;
}

# Correct Prometheus reverse proxy
location /prometheus/ {
    proxy_pass http://prometheus:9090/;  # ‚Üê notice trailing slash
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

	# Proxy Kibana (for log viewing)
	location /kibana/ {
		proxy_pass http://kibana:5601;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
	}

	# Proxy Jaeger (for distributed tracing UI)
	location /jaeger/ {
		proxy_pass http://jaeger:16686/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# Serve the frontend via the frontend service (preserve path as-is)
	# This MUST be last as it's the catch-all
	location / {
		proxy_pass http://frontend:80;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
}
